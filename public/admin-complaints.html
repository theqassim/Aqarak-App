<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´ÙƒØ§ÙˆÙŠ - Ø¹Ù‚Ø§Ø±Ùƒ</title>
    <link rel="icon" type="image/png" href="logo.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="admin-auth.js"></script>

    <style>
        /* --- ğŸ› ï¸ 1. Reset & Global Styles --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        :root {
            --glass-bg: rgba(20, 20, 20, 0.98);
            --neon-primary: #00ff88;
            --neon-secondary: #00d4ff;
            --neon-danger: #ff4444; /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© */
            --card-bg: #1a1a1a;
        }

        body.internal-page {
            background-color: #0f0f0f;
            background-image: radial-gradient(circle at 50% 0%, #1a2c25 0%, #0f0f0f 70%);
            min-height: 100vh;
            font-family: 'Cairo', sans-serif;
            color: white;
            overflow-x: hidden;
            /* Ù…Ø³Ø§ÙØ© Ù„Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª */
            padding-top: 100px !important; 
        }

        /* --- ğŸ”’ 2. Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª --- */
        .main-header {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            z-index: 9999;
            background: var(--glass-bg);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.5);
        }

        .header-container {
            display: flex; justify-content: space-between; align-items: center;
            max-width: 1250px; margin: 0 auto; width: 100%;
        }

        .logo-container { display: flex; align-items: center; gap: 10px; text-decoration: none; }
        .logo { height: 40px; border-radius: 50%; border: 2px solid var(--neon-danger); }
        .logo-text { color: white; font-weight: bold; font-size: 1.1rem; }

        .nav-button {
            text-decoration: none; color: white; border: 1px solid var(--neon-danger);
            padding: 6px 20px; border-radius: 50px; font-size: 0.85rem; transition: 0.3s;
            display: flex; align-items: center; gap: 8px; white-space: nowrap; cursor: pointer;
        }
        .nav-button:hover { background: var(--neon-danger); color: white; }

        /* --- Main Content --- */
        .main-content { max-width: 800px; margin: 0 auto; padding: 20px 15px; }
        
        .page-title { 
            text-align: center; margin-bottom: 40px; font-size: 2rem; 
            color: var(--neon-danger); text-shadow: 0 0 15px rgba(255, 68, 68, 0.3);
        }

        /* --- Complaint Cards Design --- */
        #complaints-list { display: flex; flex-direction: column; gap: 20px; }

        .complaint-card {
            background: var(--card-bg);
            border: 1px solid #333;
            border-radius: 16px;
            padding: 25px;
            position: relative; overflow: hidden;
            transition: 0.3s;
        }
        
        /* Ø´Ø±ÙŠØ· Ø£Ø­Ù…Ø± Ø¹Ù„ÙˆÙŠ */
        .complaint-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: var(--neon-danger);
        }

        .complaint-card:hover { border-color: var(--neon-danger); box-shadow: 0 5px 20px rgba(255, 68, 68, 0.15); }

        .complaint-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 15px;
        }
        
        .user-info h3 { font-size: 1.2rem; color: white; margin: 0 0 5px 0; display: flex; align-items: center; gap: 8px; }
        .user-phone { color: #888; font-family: monospace; font-size: 0.95rem; display: block; }
        
        .complaint-date { font-size: 0.8rem; color: #666; background: rgba(255,255,255,0.05); padding: 5px 10px; border-radius: 6px; }

        .complaint-body {
            font-size: 1rem; line-height: 1.7; color: #ddd; background: rgba(255, 68, 68, 0.05);
            padding: 15px; border-radius: 10px; border: 1px dashed rgba(255, 68, 68, 0.3); margin-bottom: 20px;
        }

        /* Buttons */
        .actions-row { display: flex; gap: 10px; flex-wrap: wrap; }
        
        .action-btn {
            flex: 1; padding: 10px; border-radius: 50px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.3s; text-decoration: none; font-size: 0.9rem;
            min-width: 140px;
        }

        .btn-whatsapp { 
            background: transparent; border: 1px solid #25d366; color: #25d366; 
        }
        .btn-whatsapp:hover { background: #25d366; color: white; }

        .btn-delete { 
            background: transparent; border: 1px solid var(--neon-danger); color: var(--neon-danger); 
        }
        .btn-delete:hover { background: var(--neon-danger); color: white; }

        .empty-message { text-align: center; padding: 40px; color: #888; border: 2px dashed #333; border-radius: 15px; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body.internal-page { padding-top: 130px !important; }
            .complaint-header { flex-direction: column; gap: 10px; align-items: flex-start; }
            .logo-text { display: none; }
            .actions-row { flex-direction: column; }
        }
    </style>
</head>
<body class="internal-page">

    <header class="main-header">
        <div class="header-container">
            <div class="logo-container">
                <img src="logo.jpg" alt="Ø´Ø¹Ø§Ø± Ø¹Ù‚Ø§Ø±Ùƒ" class="logo">
                <span class="logo-text">ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø´ÙƒØ§ÙˆÙŠ (Admin)</span>
            </div>
            <nav class="main-nav">
                <a href="admin-home" class="nav-button">
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ© <i class="fas fa-arrow-left" style="margin-right:5px;"></i>
                </a>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <h1 class="page-title">Ø§Ù„Ø´ÙƒØ§ÙˆÙŠ Ø§Ù„ÙˆØ§Ø±Ø¯Ø© ğŸ“¥</h1>
        
        <div id="complaints-list">
            <p class="empty-message" style="color:var(--neon-danger)">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´ÙƒØ§ÙˆÙŠ <i class="fas fa-spinner fa-spin"></i></p>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            loadComplaints();
        });

       async function loadComplaints() {
            const list = document.getElementById('complaints-list');
            try {
                const res = await fetch('/api/admin/complaints');
                const complaints = await res.json();
                
                list.innerHTML = '';
                if(complaints.length === 0) {
                    list.innerHTML = `
                        <div class="empty-message">
                            <i class="fas fa-check-double" style="font-size:3rem; color:var(--neon-primary); margin-bottom:15px; display:block;"></i>
                            Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´ÙƒØ§ÙˆÙŠ Ø¬Ø¯ÙŠØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.
                        </div>`;
                    return;
                }

                complaints.forEach(c => {
                    const date = new Date(c.created_at).toLocaleDateString('ar-EG') + ' ' + new Date(c.created_at).toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'});
                    
                    // ğŸŸ¢ ØªØ¬Ù‡ÙŠØ² Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
                    let cleanPhone = c.user_phone.replace(/\D/g, ''); 
                    if (cleanPhone.startsWith('01')) cleanPhone = '2' + cleanPhone; 
                    const waLink = `https://wa.me/${cleanPhone}`;

                    const html = `
                        <div class="complaint-card" id="card-${c.id}">
                            <div class="complaint-header">
                                <div class="user-info">
                                    <h3><i class="fas fa-user-circle"></i> ${c.user_name || 'Ù…Ø³ØªØ®Ø¯Ù…'}</h3>
                                    <span class="user-phone"><i class="fas fa-phone-alt"></i> ${c.user_phone}</span>
                                </div>
                                <div class="complaint-date"><i class="far fa-clock"></i> ${date}</div>
                            </div>

                            <div class="complaint-body">
                                <i class="fas fa-quote-right" style="color:var(--neon-danger); margin-left:5px; opacity:0.5;"></i>
                                ${c.content}
                            </div>
                            
                            <div class="actions-row">
                                <a href="${waLink}" target="_blank" class="action-btn btn-whatsapp">
                                    <i class="fab fa-whatsapp" style="font-size:1.2rem;"></i> ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨
                                </a>
                                <button onclick="deleteComplaint(${c.id})" class="action-btn btn-delete">
                                    <i class="fas fa-trash-alt"></i> ØªÙ… Ø§Ù„Ø­Ù„ (Ø­Ø°Ù)
                                </button>
                            </div>
                        </div>
                    `;
                    list.innerHTML += html;
                });

            } catch(e) {
                list.innerHTML = `<p class="empty-message" style="color:red;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>`;
            }
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù
        async function deleteComplaint(id) {
            if(!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø´ÙƒÙˆÙ‰ØŸ\nØ³ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.')) return;

            const btn = document.querySelector(`#card-${id} .btn-delete`);
            const originalHTML = btn.innerHTML;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...';
            btn.disabled = true;

            try {
                const res = await fetch(`/api/admin/complaint/${id}`, { method: 'DELETE' });
                const data = await res.json();

                if (res.ok) {
                    // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„Ø­Ø°Ù
                    const card = document.getElementById(`card-${id}`);
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        card.remove();
                        if(document.querySelectorAll('.complaint-card').length === 0) loadComplaints();
                    }, 300);
                } else {
                    alert('âŒ Ø®Ø·Ø£: ' + data.message);
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                }
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±');
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>