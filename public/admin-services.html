<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>عقارك - إدارة الخدمات</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="icon" type="image/png" href="logo.png" />
    <style>
      :root {
        --glass-bg: rgba(20, 20, 20, 0.98);
        --neon-primary: #00ff88;
        --neon-secondary: #00d4ff;
        --neon-purple: #d500f9;
        --neon-gold: #ffd700;
        --card-bg: #1a1a1a;
      }

      body {
        background-color: #0f0f0f;
        background-image: radial-gradient(
          circle at 50% 0%,
          #1a2c25 0%,
          #0f0f0f 70%
        );
        min-height: 100vh;
        font-family: "Cairo", sans-serif;
        color: white;
        margin: 0;
        padding-top: 80px;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }

      .page-header {
        text-align: center;
        margin-bottom: 40px;
      }
      .page-title {
        color: var(--neon-secondary);
        font-size: 2rem;
        text-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        margin-bottom: 10px;
      }

      .form-box {
        background: var(--card-bg);
        border: 1px solid #333;
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        position: relative;
        overflow: hidden;
        margin-bottom: 50px;
      }
      .form-box::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(
          90deg,
          var(--neon-purple),
          var(--neon-secondary)
        );
      }

      .input-group {
        margin-bottom: 20px;
      }
      .input-group label {
        display: block;
        margin-bottom: 8px;
        color: #ccc;
        font-weight: bold;
      }

      .neon-input {
        width: 100%;
        padding: 12px;
        background: #111;
        border: 1px solid #444;
        color: white;
        border-radius: 8px;
        font-family: "Cairo";
        outline: none;
        transition: 0.3s;
        box-sizing: border-box;
      }
      .neon-input:focus {
        border-color: var(--neon-purple);
        box-shadow: 0 0 10px rgba(213, 0, 249, 0.2);
      }

      .type-selector {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
      }
      .type-option {
        flex: 1;
        padding: 15px;
        border: 1px solid #444;
        border-radius: 10px;
        cursor: pointer;
        text-align: center;
        transition: 0.3s;
        background: #0f0f0f;
        color: #888;
      }
      .type-option.selected {
        border-color: var(--neon-secondary);
        background: rgba(0, 212, 255, 0.1);
        color: var(--neon-secondary);
        box-shadow: 0 0 10px rgba(0, 212, 255, 0.1);
      }
      .type-option i {
        font-size: 1.5rem;
        margin-bottom: 5px;
        display: block;
      }

      .btn-submit {
        width: 100%;
        padding: 15px;
        background: linear-gradient(45deg, var(--neon-purple), #7c4dff);
        color: white;
        border: none;
        border-radius: 50px;
        font-weight: bold;
        cursor: pointer;
        font-size: 1.1rem;
        margin-top: 10px;
        transition: 0.3s;
      }
      .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(124, 77, 255, 0.3);
      }

      .services-section-title {
        color: #ccc;
        border-bottom: 1px solid #333;
        padding-bottom: 10px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .service-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #151515;
        padding: 15px;
        border-radius: 12px;
        border: 1px solid #333;
        margin-bottom: 15px;
        transition: 0.3s;
      }

      .service-item.pinned {
        border-color: var(--neon-gold);
        background: rgba(255, 215, 0, 0.03);
      }

      .service-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .service-img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #444;
        background: #fff;
      }

      .service-details h4 {
        margin: 0;
        color: white;
        font-size: 1.1rem;
      }
      .service-details small {
        color: #888;
      }

      .actions {
        display: flex;
        gap: 10px;
      }

      .btn-action {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.3s;
        font-size: 1rem;
      }

      .btn-pin {
        background: transparent;
        border: 1px solid #555;
        color: #555;
      }
      .btn-pin:hover {
        border-color: var(--neon-gold);
        color: var(--neon-gold);
      }
      .btn-pin.active {
        background: var(--neon-gold);
        color: black;
        border-color: var(--neon-gold);
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
      }

      .btn-delete {
        background: rgba(255, 68, 68, 0.1);
        border: 1px solid #ff4444;
        color: #ff4444;
      }
      .btn-delete:hover {
        background: #ff4444;
        color: white;
      }

      .back-link {
        display: block;
        text-align: center;
        margin-top: 40px;
        color: #777;
        text-decoration: none;
        transition: 0.3s;
      }
      .back-link:hover {
        color: white;
      }

      @media (max-width: 600px) {
        .service-item {
          flex-direction: column;
          text-align: center;
          gap: 15px;
        }
        .service-info {
          flex-direction: column;
        }
      }
      :root {
        --glass-bg: rgba(20, 20, 20, 0.98);
        --neon-secondary: #00d4ff;
        --text-white: #ffffff;
      }

      .main-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        width: 100%;
        z-index: 9999;
        background: var(--glass-bg);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding: 10px 15px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.5);
      }

      .header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1250px;
        margin: 0 auto;
        width: 100%;
      }

      .logo-container {
        display: flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
      }

      .logo {
        height: 45px;
        border-radius: 50%;
        border: 2px solid var(--neon-secondary);
      }

      .logo-text {
        color: var(--text-white);
        font-weight: bold;
        font-size: 1.1rem;
        font-family: "Cairo", sans-serif;
      }

      .nav-button {
        text-decoration: none;
        color: var(--text-white);
        border: 1px solid var(--neon-secondary);
        padding: 8px 20px;
        border-radius: 50px;
        font-size: 0.9rem;
        transition: 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
        font-family: "Cairo", sans-serif;
        background: transparent;
      }

      .nav-button:hover {
        background: var(--neon-secondary);
        color: black;
        box-shadow: 0 0 15px rgba(0, 212, 255, 0.4);
      }

      .nav-button.active {
        background: var(--neon-secondary);
        color: black;
        font-weight: bold;
        box-shadow: 0 0 10px rgba(0, 212, 255, 0.6);
      }

      @media (max-width: 768px) {
        .logo-text {
          display: none;
        }
        .logo {
          height: 40px;
        }
        .nav-button {
          padding: 6px 12px;
          font-size: 0.8rem;
        }
      }
    </style>
  </head>
  <body>
    <header class="main-header">
      <div class="header-container">
        <a href="admin-home" class="logo-container">
          <img src="logo.png" alt="شعار عقارك" class="logo" />
          <span class="logo-text">عقارك</span>
        </a>

        <nav class="main-nav" style="display: flex; gap: 10px">
          <a href="admin-home" class="nav-button active">
            <i class="fas fa-home"></i> الرئيسية
          </a>
        </nav>
      </div>
    </header>
    <div class="container">
      <div class="page-header">
        <h1 class="page-title">
          <i class="fas fa-handshake"></i> إدارة الخدمات
        </h1>
        <p style="color: #888">
          أضف شركاء جدد أو ثبت الخدمات المهمة في المقدمة
        </p>
      </div>

      <form id="add-service-form" class="form-box">
        <h3
          style="
            color: white;
            margin-top: 0;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
            margin-bottom: 20px;
          "
        >
          <i class="fas fa-plus-circle"></i> إضافة خدمة جديدة
        </h3>

        <div class="input-group">
          <label>اسم الشركة / الخدمة</label>
          <input
            type="text"
            name="title"
            class="neon-input"
            required
            placeholder="مثال: الهندسية للتشطيبات"
          />
        </div>

        <div class="input-group">
          <label>شعار الشركة (Logo)</label>
          <input
            type="file"
            name="image"
            class="neon-input"
            accept="image/*"
            required
          />
        </div>

        <div class="input-group">
          <label>نوع الرابط</label>
          <div class="type-selector">
            <div class="type-option selected" onclick="selectType('website')">
              <i class="fas fa-globe"></i> <span>موقع إلكتروني</span>
            </div>
            <div class="type-option" onclick="selectType('facebook')">
              <i class="fab fa-facebook"></i> <span>صفحة فيسبوك</span>
            </div>
          </div>
          <input type="hidden" name="linkType" id="linkType" value="website" />
        </div>

        <div class="input-group">
          <label>الرابط (URL)</label>
          <input
            type="url"
            name="linkUrl"
            class="neon-input"
            required
            placeholder="https://..."
          />
        </div>

        <div class="input-group">
          <label>وصف مختصر</label>
          <textarea
            name="description"
            class="neon-input"
            rows="3"
            required
            placeholder="وصف الخدمة التي يقدمها الشريك..."
          ></textarea>
        </div>

        <button type="submit" class="btn-submit">
          نشر الخدمة <i class="fas fa-rocket"></i>
        </button>
      </form>

      <div class="services-section-title">
        <h3><i class="fas fa-list"></i> الخدمات الحالية</h3>
        <button
          onclick="fetchServicesAdmin()"
          style="
            background: none;
            border: none;
            color: var(--neon-secondary);
            cursor: pointer;
          "
        >
          <i class="fas fa-sync-alt"></i> تحديث
        </button>
      </div>

      <div id="services-list-container">
        <p style="text-align: center; color: #777">جاري التحميل...</p>
      </div>
    </div>

    <script>
      function selectType(type) {
        document.getElementById("linkType").value = type;
        document
          .querySelectorAll(".type-option")
          .forEach((el) => el.classList.remove("selected"));
        event.currentTarget.classList.add("selected");
      }

      async function fetchServicesAdmin() {
        const container = document.getElementById("services-list-container");
        container.innerHTML =
          '<p style="text-align:center; color:#777;">جاري التحميل...</p>';

        try {
          const res = await fetch("/api/services");
          const services = await res.json();

          if (services.length === 0) {
            container.innerHTML =
              '<div style="text-align:center; padding:20px; border:1px dashed #444; border-radius:10px; color:#666;">لا توجد خدمات مضافة حتى الآن.</div>';
            return;
          }

          let html = "";
          services.forEach((srv) => {
            const isPinned = srv.is_pinned;

            html += `
                        <div class="service-item ${isPinned ? "pinned" : ""}">
                            <div class="service-info">
                                <img src="${
                                  srv.image_url
                                }" class="service-img" alt="logo" onerror="this.src='logo.jpg'">
                                <div class="service-details">
                                    <h4>
                                        ${srv.title} 
                                        ${
                                          isPinned
                                            ? '<i class="fas fa-thumbtack" style="color:var(--neon-gold); font-size:0.8rem; margin-right:5px;"></i>'
                                            : ""
                                        }
                                    </h4>
                                    <small>${
                                      srv.link_type === "facebook"
                                        ? "صفحة فيسبوك"
                                        : "موقع إلكتروني"
                                    }</small>
                                </div>
                            </div>
                            
                            <div class="actions">
                                <button onclick="togglePin(${
                                  srv.id
                                }, ${!isPinned})" 
                                        class="btn-action btn-pin ${
                                          isPinned ? "active" : ""
                                        }" 
                                        title="${
                                          isPinned
                                            ? "إلغاء التثبيت"
                                            : "تثبيت في المقدمة"
                                        }">
                                    <i class="fas fa-thumbtack"></i>
                                </button>
                                
                                <button onclick="deleteService(${
                                  srv.id
                                })" class="btn-action btn-delete" title="حذف الخدمة">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
          });
          container.innerHTML = html;
        } catch (e) {
          console.error(e);
          container.innerHTML =
            '<p style="color:#ff4444; text-align:center;">فشل تحميل البيانات. تأكد من تشغيل السيرفر.</p>';
        }
      }

      document
        .getElementById("add-service-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const btn = document.querySelector(".btn-submit");
          const originalText = btn.innerHTML;
          btn.innerHTML = "جاري النشر...";
          btn.disabled = true;

          const formData = new FormData(e.target);

          try {
            const res = await fetch("/api/admin/add-service", {
              method: "POST",
              body: formData,
            });
            const data = await res.json();

            if (data.success) {
              alert("✅ تمت إضافة الخدمة بنجاح!");
              e.target.reset();
              fetchServicesAdmin();
            } else {
              alert("❌ خطأ: " + (data.message || "فشل النشر"));
            }
          } catch (err) {
            alert("حدث خطأ في الاتصال");
          } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }
        });

      async function togglePin(id, newState) {
        try {
          const res = await fetch(`/api/admin/service/pin/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ isPinned: newState }),
          });

          if (res.ok) {
            fetchServicesAdmin();
          } else {
            alert("فشل تحديث الحالة");
          }
        } catch (e) {
          alert("خطأ في الاتصال");
        }
      }

      async function deleteService(id) {
        if (!confirm("هل أنت متأكد من حذف هذه الخدمة نهائياً؟")) return;

        try {
          const res = await fetch(`/api/admin/service/${id}`, {
            method: "DELETE",
          });
          const data = await res.json();
          if (data.success) {
            fetchServicesAdmin();
          } else {
            alert("فشل الحذف");
          }
        } catch (e) {
          alert("خطأ في الاتصال");
        }
      }

      document.addEventListener("DOMContentLoaded", fetchServicesAdmin);
    </script>
  </body>
</html>
