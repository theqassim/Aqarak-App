const egyptLocations = {
  القاهرة: [
    "التجمع الخامس",
    "التجمع الأول",
    "التجمع الثالث",
    "الرحاب",
    "مدينتي",
    "الشروق",
    "بدر",
    "العاصمة الإدارية الجديدة",
    "مستقبل سيتي",
    "المعادي",
    "زهراء المعادي",
    "القطامية",
    "الهضبة الوسطى",
    "مدينة نصر",
    "مصر الجديدة",
    "شيراتون",
    "النزهة الجديدة",
    "الزيتون",
    "حدائق القبة",
    "العباسية",
    "الوايلي",
    "وسط البلد",
    "جاردن سيتي",
    "الزمالك",
    "المنيل",
    "شبرا مصر",
    "الساحل",
    "روض الفرج",
    "المرج",
    "عين شمس",
    "المطرية",
    "السلام",
    "الخانكة",
    "حلوان",
    "المعصرة",
    "التبين",
    "15 مايو",
    "حدائق العاصمة",
    "الفسطاط",
    "مصر القديمة",
    "الخليفة",
    "المقطم",
    "منشأة ناصر",
    "الأزبكية",
    "الموسكي",
    "باب الشعرية",
    "بولاق أبو العلا",
    "السيدة زينب",
  ],
  الجيزة: [
    "6 أكتوبر",
    "الشيخ زايد",
    "حدائق أكتوبر",
    "أكتوبر الجديدة",
    "حدائق الأهرام",
    "الرماية",
    "الهرم",
    "فيصل",
    "المهندسين",
    "الدقي",
    "العجوزة",
    "الكيت كات",
    "إمبابة",
    "الوراق",
    "أوسيم",
    "بشتيل",
    "المنيب",
    "البحر الأعظم",
    "الجيزة (المركز)",
    "بولاق الدكرور",
    "أرض اللواء",
    "العمرانية",
    "الطالبية",
    "ميت عقبة",
    "بين السرايات",
    "الحوامدية",
    "البدرشين",
    "العياط",
    "الصف",
    "أطفيح",
    "منشأة القناطر",
    "كرداسة",
    "ناهيا",
    "أبو النمرس",
    "الواحات البحرية",
  ],
  الاسكندرية: [
    "سموحة",
    "ميامي",
    "سيدي بشر",
    "المنتزه",
    "المعمورة",
    "المندرة",
    "العصافرة",
    "سان ستيفانو",
    "جليم",
    "زيزينيا",
    "باكوس",
    "فلمنج",
    "الظاهرية",
    "رشدي",
    "كفر عبده",
    "مصطفى كامل",
    "سيدي جابر",
    "سبورتنج",
    "كليوباترا",
    "الإبراهيمية",
    "كامب شيزار",
    "الشاطبي",
    "محرم بك",
    "الأزاريطة",
    "المنشية",
    "بحري",
    "الأنفوشي",
    "الجمرك",
    "رأس التين",
    "كرموز",
    "غيط العنب",
    "القباري",
    "الورديان",
    "المكس",
    "الدخيلة",
    "العجمي (البيطاش)",
    "العجمي (الهانوفيل)",
    "أبو يوسف",
    "شهر العسل",
    "الكيلو 21",
    "العامرية",
    "برج العرب",
    "برج العرب الجديدة",
    "كينج مريوط",
    "الساحل الشمالي (الاسكندرية)",
  ],
  القليوبية: [
    "بنها",
    "بنها الجديدة",
    "شبرا الخيمة",
    "قليوب",
    "القناطر الخيرية",
    "الخانكة",
    "الخصوص",
    "العبور",
    "العبور الجديدة",
    "شبين القناطر",
    "طوخ",
    "قها",
    "كفر شكر",
  ],
  الدقهلية: [
    "المنصورة",
    "المنصورة الجديدة",
    "طلخا",
    "ميت غمر",
    "السنبلاوين",
    "دكرنس",
    "بلقاس",
    "أجا",
    "شربين",
    "المطرية (دقهلية)",
    "المنزلة",
    "الجمالية",
    "منية النصر",
    "نبروه",
    "بني عبيد",
    "تمى الأمديد",
    "ميت سلسيل",
    "محلة دمنة",
  ],
  الشرقية: [
    "الزقازيق",
    "الزقازيق الجديدة",
    "العاشر من رمضان",
    "منيا القمح",
    "بلبيس",
    "أبو حماد",
    "فاقوس",
    "أبو كبير",
    "ههيا",
    "كفر صقر",
    "أولاد صقر",
    "ديرب نجم",
    "مشتول السوق",
    "الإبراهيمية",
    "الحسينية",
    "صان الحجر",
    "القرين",
    "القنايات",
  ],
  الغربية: [
    "طنطا",
    "المحلة الكبرى",
    "كفر الزيات",
    "زفتى",
    "السنطة",
    "بسيون",
    "قطور",
    "سمنود",
  ],
  المنوفية: [
    "شبين الكوم",
    "مدينة السادات",
    "منوف",
    "أشمون",
    "قويسنا",
    "بركة السبع",
    "تلا",
    "الباجور",
    "الشهداء",
    "سرس الليان",
  ],
  البحيرة: [
    "دمنهور",
    "كفر الدوار",
    "أبو حمص",
    "إيتاي البارود",
    "كوم حمادة",
    "الدلنجات",
    "حوش عيسى",
    "أبو المطامير",
    "المحمودية",
    "الرحمانية",
    "رشيد",
    "إدكو",
    "شبراخيت",
    "النوبارية الجديدة",
    "وادي النطرون",
    "بدر (البحيرة)",
  ],
  "كفر الشيخ": [
    "كفر الشيخ",
    "دسوق",
    "فوّه",
    "مطوبس",
    "بيلا",
    "الحامول",
    "سيدي سالم",
    "الرياض",
    "قلين",
    "بلطيم",
    "برج البرلس",
    "مصيف بلطيم",
  ],
  دمياط: [
    "دمياط",
    "دمياط الجديدة",
    "رأس البر",
    "فارسكور",
    "الزرقا",
    "كفر سعد",
    "كفر البطيخ",
    "عزبة البرج",
    "ميت أبو غالب",
    "السرو",
    "الروضة",
  ],
  بورسعيد: [
    "حي الشرق",
    "حي العرب",
    "حي المناخ",
    "حي الضواحي",
    "حي الجنوب",
    "حي الزهور",
    "حي غرب",
    "بورفؤاد",
    "مدينة سلام مصر",
  ],
  الاسماعيلية: [
    "الاسماعيلية",
    "الاسماعيلية الجديدة",
    "فايد",
    "القنطرة شرق",
    "القنطرة غرب",
    "القصاصين",
    "التب الكبير",
    "أبو صوير",
  ],
  السويس: [
    "حي السويس",
    "حي الأربعين",
    "حي عتاقة",
    "حي الجناين",
    "حي فيصل",
    "العين السخنة",
  ],
  مطروح: [
    "مرسى مطروح",
    "العلمين",
    "العلمين الجديدة",
    "الساحل الشمالي",
    "مراقيا",
    "مارينا",
    "الحمام",
    "الضبعة",
    "سيدي عبد الرحمن",
    "رأس الحكمة",
    "النجيلة",
    "سيدي براني",
    "سيوة",
    "السلوم",
  ],
  "البحر الأحمر": [
    "الغردقة",
    "الجونة",
    "سفاجا",
    "القصير",
    "مرسى علم",
    "رأس غارب",
    "حلايب",
    "شلاتين",
  ],
  "جنوب سيناء": [
    "شرم الشيخ",
    "دهب",
    "نويبع",
    "طابا",
    "الطور",
    "رأس سدر",
    "سانت كاترين",
    "أبو رديس",
    "أبو زنيمة",
  ],
  "شمال سيناء": ["العريش", "الشيخ زويد", "رفح", "بئر العبد", "الحسنة", "نخل"],
  الفيوم: [
    "الفيوم",
    "الفيوم الجديدة",
    "طامية",
    "سنورس",
    "إطسا",
    "أبشواي",
    "يوسف الصديق",
  ],
  "بني سويف": [
    "بني سويف",
    "بني سويف الجديدة",
    "الواسطى",
    "ناصر",
    "إهناسيا",
    "ببا",
    "الفشن",
    "سمسطا",
  ],
  المنيا: [
    "المنيا",
    "المنيا الجديدة",
    "ملوي",
    "بني مزار",
    "مغاغة",
    "أبو قرقاص",
    "سمالوط",
    "ديرمواس",
    "مطاي",
    "العدوة",
  ],
  أسيوط: [
    "أسيوط",
    "أسيوط الجديدة",
    "ديروط",
    "القوصية",
    "منفلوط",
    "أبوتيج",
    "صدفا",
    "الغنايم",
    "أبنوب",
    "الفتح",
    "ساحل سليم",
    "البداري",
  ],
  سوهاج: [
    "سوهاج",
    "سوهاج الجديدة",
    "أخميم",
    "أخميم الجديدة",
    "جرجا",
    "طهطا",
    "المراغة",
    "البلينا",
    "دار السلام",
    "المنشأة",
    "ساقلتة",
    "جهينة",
  ],
  قنا: [
    "قنا",
    "قنا الجديدة",
    "نجع حمادي",
    "أبوتشت",
    "فرشوط",
    "دشنا",
    "الوقف",
    "قفط",
    "قوص",
    "نقادة",
  ],
  الأقصر: [
    "الأقصر",
    "الأقصر الجديدة",
    "إسنا",
    "أرمنت",
    "الطود",
    "البياضية",
    "القرنة",
    "الزينية",
  ],
  أسوان: [
    "أسوان",
    "أسوان الجديدة",
    "كوم أمبو",
    "إدفو",
    "دراو",
    "نصر النوبة",
    "كلابشة",
    "أبو سمبل",
  ],
  "الوادي الجديد": ["الخارجة", "الداخلة", "الفرافرة", "باريس", "بلاط"],
};

document.addEventListener("DOMContentLoaded", () => {
  initLocationSelects();

  fetchUserData();

  const form = document.getElementById("request-form");
  if (form) {
    form.addEventListener("submit", handleRequestSubmit);
  }
});

function initLocationSelects() {
  const govSelect = document.getElementById("req-gov");
  const citySelect = document.getElementById("req-city");

  govSelect.innerHTML = '<option value="">اختر المحافظة...</option>';

  Object.keys(egyptLocations).forEach((gov) => {
    const option = document.createElement("option");
    option.value = gov;
    option.textContent = gov;
    govSelect.appendChild(option);
  });

  govSelect.addEventListener("change", function () {
    const selectedGov = this.value;
    citySelect.innerHTML = '<option value="">اختر المدينة / المركز...</option>';

    if (selectedGov && egyptLocations[selectedGov]) {
      egyptLocations[selectedGov].forEach((city) => {
        const option = document.createElement("option");
        option.value = city;
        option.textContent = city;
        citySelect.appendChild(option);
      });
    }
  });
}

async function fetchUserData() {
  try {
    const res = await fetch("/api/auth/me");
    if (res.ok) {
      const data = await res.json();
      if (data.isAuthenticated) {
        const nameInput = document.getElementById("req-name");
        const phoneInput = document.getElementById("req-phone");

        if (nameInput && data.name) nameInput.value = data.name;
        if (phoneInput && data.phone) phoneInput.value = data.phone;
      }
    }
  } catch (e) {}
}

async function handleRequestSubmit(e) {
  e.preventDefault();

  const btn = e.target.querySelector('button[type="submit"]');
  const originalContent = btn.innerHTML;

  const formData = {
    name: document.getElementById("req-name")?.value.trim(),
    phone: document.getElementById("req-phone")?.value.trim(),
    type: document.getElementById("req-type")?.value,
    maxPrice: document.getElementById("req-price")?.value,
    governorate: document.getElementById("req-gov")?.value,
    city: document.getElementById("req-city")?.value,
    specifications: document.getElementById("req-notes")?.value.trim(),
  };

  if (
    !formData.name ||
    !formData.phone ||
    !formData.governorate ||
    !formData.city
  ) {
    if (typeof Swal !== "undefined") {
      Swal.fire({
        icon: "warning",
        title: "بيانات ناقصة",
        text: "يرجى التأكد من اختيار المحافظة والمدينة ورقم الهاتف.",
        confirmButtonText: "حسناً",
        confirmButtonColor: "#d33",
      });
    } else {
      alert("يرجى ملء جميع الحقول المطلوبة (الاسم، الهاتف، الموقع)");
    }
    return;
  }

  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
  btn.disabled = true;

  try {
    const response = await fetch("/api/request-property", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(formData),
    });

    const result = await response.json();

    if (response.ok && result.success) {
      if (typeof Swal !== "undefined") {
        await Swal.fire({
          icon: "success",
          title: "تم تسجيل طلبك!",
          text: "سنقوم بالبحث في شبكتنا وإبلاغك فور توفر عقار مناسب.",
          confirmButtonText: "العودة للرئيسية",
          confirmButtonColor: "#00ff88",
          background: "#111",
          color: "#fff",
        });
      } else {
        alert("✅ تم تسجيل طلبك بنجاح!");
      }

      window.location.href = "/home";
    } else {
      throw new Error(result.message || "فشل التسجيل");
    }
  } catch (error) {
    console.error("Submission Error:", error);

    if (typeof Swal !== "undefined") {
      Swal.fire({
        icon: "error",
        title: "خطأ",
        text: "حدث خطأ في الاتصال، يرجى المحاولة مرة أخرى.",
        confirmButtonText: "حاول مرة أخرى",
      });
    } else {
      alert("❌ حدث خطأ في الاتصال بالسيرفر.");
    }
  } finally {
    btn.innerHTML = originalContent;
    btn.disabled = false;
  }
}
