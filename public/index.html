<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>Ø¹Ù‚Ø§Ø±Ùƒ - Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</title>
    <link rel="stylesheet" href="styles.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .auth-tabs { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
        .tab-btn { background: transparent; border: none; color: #fff; padding: 10px 20px; cursor: pointer; font-size: 1.1rem; border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom: 2px solid #00ff88; color: #00ff88; }
        .otp-group { display: none; margin-top: 15px; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .error-msg { color: #ff4444; font-size: 0.85rem; font-weight: bold; display: block; margin-bottom: 5px; min-height: 20px; }
        .password-strength { height: 5px; width: 100%; background: #333; margin-top: 5px; border-radius: 3px; }
        .strength-bar { height: 100%; width: 0%; border-radius: 3px; transition: width 0.3s, background 0.3s; }
        .strength-text { font-size: 0.75rem; float: left; margin-top: 3px; }

        /* Ø³ØªØ§ÙŠÙ„ Ø­Ù‚Ù„ Ø§Ù„ÙŠÙˆØ²Ø± Ù†ÙŠÙ… (Ø§Ù†Ø³ØªØ¬Ø±Ø§Ù… Ø³ØªØ§ÙŠÙ„) */
        .input-wrapper { position: relative; }
        .validation-icon { position: absolute; left: 15px; top: 38px; font-size: 1.2rem; display: none; }
        .fa-check-circle { color: #00ff88; }
        .fa-times-circle { color: #ff4444; }
        .username-error { color: #ff4444; font-size: 0.75rem; margin-top: 2px; display: none; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
        .modal-content { background-color: #1c2630; margin: 15% auto; padding: 20px; border: 1px solid #00ff88; width: 90%; max-width: 400px; border-radius: 10px; text-align: center; color: white; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .forgot-link { color: #aaa; font-size: 0.9rem; margin-top: 10px; display: block; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body class="centered-body">

    <main class="main-content">
        <div class="auth-frame neon-glow centered-page-content">

            <div class="auth-tabs">
                <button class="tab-btn active" onclick="switchTab('login')">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
                <button class="tab-btn" onclick="switchTab('register')">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
            </div>

            <div id="login-form-wrapper">
                <form id="login-form" class="auth-form">
                    <div class="input-group">
                        <span id="login-phone-error" class="error-msg"></span>
                        <label>Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</label>
                        <input type="tel" id="login-phone" class="neon-input-white" placeholder="01xxxxxxxxx" required>
                    </div>
                    <div class="input-group">
                        <span id="login-pass-error" class="error-msg"></span>
                        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <input type="password" id="login-password" class="neon-input-white" required>
                    </div>
                    <button type="submit" class="btn-neon-auth">Ø¯Ø®ÙˆÙ„</button>
                    <span class="forgot-link" onclick="openForgotModal()">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</span>
                </form>
            </div>

            <div id="register-form-wrapper" style="display:none;">
                <form id="register-form" class="auth-form">
                    <div id="reg-step-1">
                        <div class="input-group">
                            <label>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</label>
                            <input type="text" id="reg-name" class="neon-input-white" required>
                        </div>

                        <div class="input-group input-wrapper">
                            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (5 Ø­Ø±ÙˆÙ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ØµØºÙŠØ±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)</label>
                            <input type="text" id="reg-username" class="neon-input-white" placeholder="username" required minlength="5">
                            <i id="icon-check" class="fas fa-check-circle validation-icon"></i>
                            <i id="icon-error" class="fas fa-times-circle validation-icon"></i>
                            <p id="username-msg" class="username-error">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„</p>
                        </div>

                        <div class="input-group">
                            <span id="reg-phone-error" class="error-msg"></span>
                            <label>Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</label>
                            <input type="tel" id="reg-phone" class="neon-input-white" placeholder="01xxxxxxxxx" required>
                        </div>

                        <div class="input-group">
                            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                            <input type="password" id="reg-password" class="neon-input-white" onkeyup="checkStrength()" required>
                            <div class="password-strength"><div id="strength-bar" class="strength-bar"></div></div>
                            <span id="strength-text" class="strength-text" style="color: #aaa;"></span>
                        </div>

                        <div class="input-group">
                            <label>ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                            <input type="password" id="reg-confirm-password" class="neon-input-white" required>
                            <span id="confirm-pass-error" class="error-msg"></span>
                        </div>
                    </div>

                    <div class="input-group otp-group" id="reg-otp-group">
                        <label style="color: #00ff88;">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ âœ…</label>
                        <input type="text" id="reg-otp" class="neon-input-white" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ (4 Ø£Ø±Ù‚Ø§Ù…)">
                    </div>

                    <button type="submit" class="btn-neon-auth" id="reg-submit-btn">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
                </form>
            </div>

        </div>
    </main>

    <div id="forgotModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeForgotModal()">&times;</span>
            <h3>Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
            <p id="forgot-message" class="message"></p>
            <div id="forgot-step-1">
                <input type="tel" id="forgot-phone" class="neon-input-white" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨" style="width:90%; margin-bottom:10px;">
                <button class="btn-neon-auth" onclick="sendForgotOTP()">Ø£Ø±Ø³Ù„ Ø§Ù„ÙƒÙˆØ¯</button>
            </div>
            <div id="forgot-step-2" style="display:none;">
                <input type="text" id="forgot-otp" class="neon-input-white" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚" style="width:90%; margin-bottom:10px;">
                <input type="password" id="new-password" class="neon-input-white" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" style="width:90%; margin-bottom:10px;">
                <button class="btn-neon-auth" onclick="resetPassword()">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©
        try {
            const response = await fetch('/api/auth/me');
            const userData = await response.json();
            if (userData.isAuthenticated) {
                localStorage.setItem('userPhone', userData.phone);
                if(userData.username) localStorage.setItem('username', userData.username);
                window.location.href = userData.role === 'admin' ? 'admin-home' : '/';
            }
        } catch (e) {}

        // ğŸŸ¢ 1. Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        const loginForm = document.getElementById('login-form');
        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                document.getElementById('login-phone-error').textContent = '';
                document.getElementById('login-pass-error').textContent = '';

                const phone = document.getElementById('login-phone').value;
                const password = document.getElementById('login-password').value;

                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ phone, password }),
                    });
                    const data = await response.json();

                    if (data.success) {
                        localStorage.setItem('username', data.username);
                        window.location.href = data.role === 'admin' ? 'admin-home' : '/';
                    } else {
                        if (data.errorType === 'phone' || response.status === 404) {
                            document.getElementById('login-phone-error').textContent = data.message;
                        } else if (data.errorType === 'password' || response.status === 401) {
                            document.getElementById('login-pass-error').textContent = data.message;
                        } else {
                            alert(data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ');
                        }
                    }
                } catch (error) { alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±'); }
            });
        }

        // ğŸŸ¢ 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const registerForm = document.getElementById('register-form');
        let isOtpSent = false;
        let isUsernameValid = false;

        const usernameInput = document.getElementById('reg-username');
        const iconCheck = document.getElementById('icon-check');
        const iconError = document.getElementById('icon-error');
        const usernameMsg = document.getElementById('username-msg');
        let typingTimer;

        if (usernameInput) {
            // ğŸ”’ Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„ØµØºÙŠØ±Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
            usernameInput.addEventListener('input', (e) => {
                const originalVal = e.target.value;
                // ØªØ­ÙˆÙŠÙ„ Ù„Ø³Ù…ÙˆÙ„ + Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø±Ù…Ø² ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­
                const cleanVal = originalVal.toLowerCase().replace(/[^a-z0-9_.]/g, '');
                
                if (originalVal !== cleanVal) {
                    e.target.value = cleanVal;
                }
            });

            // ğŸ”’ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ± (ÙÙ‚Ø· Ù„Ùˆ Ø§Ù„Ø·ÙˆÙ„ 5 Ø£Ùˆ Ø£ÙƒØ«Ø±)
            usernameInput.addEventListener('keyup', () => {
                clearTimeout(typingTimer);
                const val = usernameInput.value;

                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø©
                iconCheck.style.display = 'none';
                iconError.style.display = 'none';
                usernameMsg.style.display = 'none';
                isUsernameValid = false;

                // ğŸŸ¢ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ù„Ø§ ØªÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£Ù‚Ù„ Ù…Ù† 5
                if (val.length < 5) return;

                typingTimer = setTimeout(async () => {
                    try {
                        const res = await fetch('/api/check-username', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ username: val })
                        });
                        const data = await res.json();

                        if (data.available) {
                            iconCheck.style.display = 'block'; // âœ…
                            isUsernameValid = true;
                        } else {
                            iconError.style.display = 'block'; // âŒ
                            usernameMsg.style.display = 'block';
                            usernameMsg.textContent = data.message === 'taken' 
                                ? 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„' 
                                : 'ØµÙŠØºØ© Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                        }
                    } catch (e) { console.error(e); }
                }, 500);
            });
        }

        if (registerForm) {
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                document.getElementById('reg-phone-error').textContent = '';
                document.getElementById('confirm-pass-error').textContent = '';

                const name = document.getElementById('reg-name').value;
                const username = document.getElementById('reg-username').value;
                const phone = document.getElementById('reg-phone').value;
                const password = document.getElementById('reg-password').value;
                const confirmPassword = document.getElementById('reg-confirm-password').value;
                const submitBtn = document.getElementById('reg-submit-btn');

                // --- Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø§Ù„ØªØ­Ù‚Ù‚ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ---
                if (!isOtpSent) {
                    
                    // ğŸ”’ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø·ÙˆÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (5 Ø­Ø±ÙˆÙ)
                    if (username.length < 5) {
                        alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 5 Ø­Ø±ÙˆÙ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                        usernameInput.focus();
                        return;
                    }

                    if (!isUsernameValid) {
                        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ù…ØªØ§Ø­ ÙˆØµØ­ÙŠØ­ Ø£ÙˆÙ„Ø§Ù‹.');
                        usernameInput.focus();
                        return;
                    }

                    if (password !== confirmPassword) {
                        document.getElementById('confirm-pass-error').textContent = 'ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†!';
                        return;
                    }

                    if (!isPasswordStrong(password)) {
                        document.getElementById('strength-text').textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹.';
                        document.getElementById('strength-text').style.color = 'red';
                        return;
                    }

                    submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
                    submitBtn.disabled = true;

                    try {
                        const response = await fetch('/api/auth/send-otp', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ phone, type: 'register' }) 
                        });
                        const data = await response.json();

                        if (data.success) {
                            isOtpSent = true;
                            document.getElementById('reg-otp-group').style.display = 'block';
                            document.getElementById('reg-phone').readOnly = true; 
                            document.getElementById('reg-username').readOnly = true;
                            submitBtn.textContent = 'ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨';
                            submitBtn.disabled = false;
                        } else {
                            if (response.status === 409) {
                                document.getElementById('reg-phone-error').textContent = data.message;
                            } else {
                                alert(data.message);
                            }
                            submitBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨';
                            submitBtn.disabled = false;
                        }
                    } catch (error) {
                        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                        submitBtn.disabled = false;
                    }

                } 
                // --- Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ---
                else {
                    const otp = document.getElementById('reg-otp').value;
                    if (!otp) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯!');

                    try {
                        const response = await fetch('/api/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name, username, phone, password, otp }),
                        });
                        const data = await response.json();

                        if (data.success) {
                            alert('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„Ø¯Ø®ÙˆÙ„.');
                            setTimeout(() => { switchTab('login'); document.getElementById('login-phone').value = phone; }, 1000);
                        } else {
                            alert(data.message);
                        }
                    } catch (error) { alert('Ø®Ø·Ø£'); }
                }
            });
        }
    });

    // === Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ===
    function checkStrength() {
        const password = document.getElementById('reg-password').value;
        const bar = document.getElementById('strength-bar');
        const text = document.getElementById('strength-text');
        let strength = 0;
        if (password.length >= 6) strength++;
        if (password.match(/[a-z]+/)) strength++;
        if (password.match(/[0-9]+/)) strength++;
        if (password.match(/[$@#&!]+/)) strength++;

        if (password.length < 6) {
            bar.style.width = '20%'; bar.style.background = 'red'; text.textContent = 'Ø¶Ø¹ÙŠÙØ©'; text.style.color = 'red';
        } else if (strength <= 2) {
            bar.style.width = '50%'; bar.style.background = 'orange'; text.textContent = 'Ù…ØªÙˆØ³Ø·Ø©'; text.style.color = 'orange';
        } else {
            bar.style.width = '100%'; bar.style.background = '#00ff88'; text.textContent = 'Ù‚ÙˆÙŠØ©'; text.style.color = '#00ff88';
        }
    }
    function isPasswordStrong(password) {
        let strength = 0;
        if (password.length >= 6) strength++;
        if (password.match(/[a-z]+/)) strength++;
        if (password.match(/[0-9]+/)) strength++;
        return strength >= 2; 
    }
    function switchTab(tab) {
        const loginWrapper = document.getElementById('login-form-wrapper');
        const registerWrapper = document.getElementById('register-form-wrapper');
        const btns = document.querySelectorAll('.tab-btn');
        document.querySelectorAll('.error-msg').forEach(e => e.textContent = '');
        if (tab === 'login') {
            loginWrapper.style.display = 'block'; registerWrapper.style.display = 'none';
            btns[0].classList.add('active'); btns[1].classList.remove('active');
        } else {
            loginWrapper.style.display = 'none'; registerWrapper.style.display = 'block';
            btns[0].classList.remove('active'); btns[1].classList.add('active');
        }
    }
    const modal = document.getElementById("forgotModal");
    const msgForgot = document.getElementById("forgot-message");
    function openForgotModal() { modal.style.display = "block"; }
    function closeForgotModal() { modal.style.display = "none"; }
    window.onclick = function(event) { if (event.target == modal) closeForgotModal(); }
    async function sendForgotOTP() {
        const phone = document.getElementById('forgot-phone').value;
        const msg = document.getElementById('forgot-message');
        msg.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
        try {
            const response = await fetch('/api/auth/send-otp', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ phone, type: 'reset' }) });
            const data = await response.json();
            if (data.success) {
                msg.textContent = 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'; msg.style.color = 'green';
                document.getElementById('forgot-step-1').style.display = 'none';
                document.getElementById('forgot-step-2').style.display = 'block';
            } else { msg.textContent = data.message; msg.style.color = 'red'; }
        } catch(e) { msg.textContent = 'Ø®Ø·Ø£'; }
    }
    async function resetPassword() {
        const phone = document.getElementById('forgot-phone').value;
        const otp = document.getElementById('forgot-otp').value;
        const newPassword = document.getElementById('new-password').value;
        const msg = document.getElementById('forgot-message');
        try {
            const response = await fetch('/api/auth/reset-password', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ phone, otp, newPassword }) });
            const data = await response.json();
            if (data.success) {
                msg.textContent = 'ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ±!'; msg.style.color = 'green';
                setTimeout(closeForgotModal, 2000);
            } else { msg.textContent = data.message; msg.style.color = 'red'; }
        } catch(e) { msg.textContent = 'Ø®Ø·Ø£'; }
    }
    </script>
</body>
</html>